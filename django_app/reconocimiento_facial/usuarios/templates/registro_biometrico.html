{% extends 'base.html' %}
{% load static %}

{% block title %}Registro Biom√©trico{% endblock %}

{% block extra_css %}
<style>
    /* Eliminar padding del wrapper */
    #page-content-wrapper {
        padding: 0 !important;
    }

    /* ===================================
       CREDENCIAL INACAP (Modal)
       =================================== */
    .credencial-card {
        max-width: 450px;
        margin: 0 auto;
        background: linear-gradient(135deg, #de4949 0%, #b82020 50%, #800000 100%);
        border-radius: 20px;
        padding: 35px;
        color: white;
        box-shadow: 0 15px 50px rgba(222, 73, 73, 0.5);
    }

    .credencial-header {
        text-align: center;
        font-size: 32px;
        font-weight: 800;
        margin-bottom: 25px;
        text-transform: uppercase;
        letter-spacing: 3px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .credencial-foto {
        width: 220px;
        height: 220px;
        border-radius: 15px;
        object-fit: cover;
        display: block;
        margin: 0 auto 25px;
        border: 5px solid white;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }

    .credencial-info {
        background: rgba(255, 255, 255, 0.18);
        padding: 22px;
        border-radius: 12px;
        margin-bottom: 25px;
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .credencial-info h3 {
        margin: 0 0 18px 0;
        font-size: 24px;
        font-weight: 700;
        text-align: center;
    }

    .credencial-info p {
        margin: 10px 0;
        font-size: 17px;
        display: flex;
        justify-content: space-between;
    }

    .credencial-info strong {
        font-weight: 600;
    }

    .credencial-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .credencial-actions .btn {
        flex: 1;
        font-weight: 600;
        padding: 12px;
        font-size: 1rem;
    }

    #credencialModal .modal-content {
        background: transparent;
        border: none;
    }

    /* Header rojo INACAP */
    .page-header {
        background: linear-gradient(90deg, #de4949, #b82020, #800000);
        color: white;
        padding: 30px 40px;
        margin: 0;
        box-shadow: 0 4px 15px rgba(222, 73, 73, 0.3);
    }

    .page-header h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 600;
        color: white;
    }

    .page-header .subtitle {
        margin-top: 10px;
        font-size: 1.1rem;
        opacity: 0.9;
        color: white;
    }

    .page-header i {
        font-size: 1.8rem;
        margin-right: 15px;
        vertical-align: middle;
    }

    /* Contenido con padding */
    .content-wrapper {
        padding: 30px 40px;
    }

    .registro-form {
        max-width: 700px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .device-status {
        text-align: center;
        margin-bottom: 25px;
        padding: 15px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
    }

    .device-online {
        background: #d4edda;
        color: #155724;
        border: 2px solid #c3e6cb;
    }

    .device-offline {
        background: #f8d7da;
        color: #721c24;
        border: 2px solid #f5c6cb;
    }

    .status-message {
        margin-top: 20px;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        font-weight: 600;
        display: none;
    }

    .status-message.success {
        background: #d4edda;
        color: #155724;
        border: 2px solid #c3e6cb;
    }

    .status-message.error {
        background: #f8d7da;
        color: #721c24;
        border: 2px solid #f5c6cb;
    }

    .status-message.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 2px solid #bee5eb;
    }

    .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-red);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header rojo INACAP -->
<div class="page-header">
    <h1>
        <i class="bi bi-camera"></i>
        Registro Biom√©trico
    </h1>
    <p class="subtitle">Sistema de Control de Acceso con LuckFox - Captura de Vectores Faciales</p>
</div>

<!-- Contenido con padding -->
<div class="content-wrapper">
    <!-- RTSP stream - no requiere verificaci√≥n de conexi√≥n -->

    <!-- Formulario de registro -->
    <div class="registro-form">
        <!-- Vista Previa de Captura -->
        <div class="text-center mb-4">
            <!-- Barra de progreso (arriba, fuera de la c√°mara) -->
            <div id="progressContainer"
                style="display: none; margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); border-radius: 10px; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);">
                <div style="color: white; font-size: 1.2rem; margin-bottom: 10px; font-weight: 600;">
                    <i class="bi bi-camera-fill"></i> Capturando rostro...
                </div>
                <div class="progress"
                    style="height: 35px; background: rgba(255,255,255,0.2); border-radius: 20px; overflow: hidden;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                        style="width: 0%; font-size: 1.2rem; font-weight: bold; background: white; color: #dc3545;"
                        role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <div id="progressText"
                    style="color: white; text-align: center; margin-top: 8px; font-size: 1rem; font-weight: 500;">
                    Preparando captura...
                </div>
            </div>

            <!-- Contenedor de c√°mara -->
            <div id="cameraContainer"
                style="position: relative; display: inline-block; width: 100%; height: 480px; background: #000; border-radius: 10px; overflow: hidden; border: 3px solid #ddd;">

                <!-- Placeholder inicial (c√°mara apagada) -->
                <div id="cameraPlaceholder"
                    style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #1a1a1a; color: white; z-index: 5;">
                    <i class="bi bi-camera-video" style="font-size: 4rem; opacity: 0.5; margin-bottom: 20px;"></i>
                    <div style="font-size: 1.2rem; opacity: 0.8;">C√°mara en espera</div>
                    <div style="font-size: 0.9rem; opacity: 0.6; margin-top: 10px;">
                        Presiona "Capturar Rostro" para iniciar
                    </div>
                </div>

                <!-- Stream de video (oculto inicialmente) -->
                <img id="streamImage" src="/luckfox/stream/" alt="LuckFox Camera Stream"
                    style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none;">

                <div
                    style="position: absolute; bottom: 0; left: 0; right: 0; color: white; background: rgba(0,0,0,0.6); padding: 8px; font-size: 0.9rem;">
                    <i class="bi bi-camera-video-fill"></i> <span id="cameraStatus">Vista en espera</span>
                </div>
            </div>
        </div>


        <form id="registroForm">
            <div class="mb-3">
                <label for="nombre" class="form-label">Nombre Completo *</label>
                <input type="text" class="form-control" id="nombre" name="nombre" required
                    placeholder="Ej: Daniel Soto C√°ceres">
            </div>

            <div class="mb-3">
                <label for="rut" class="form-label">RUT *</label>
                <div class="row g-2">
                    <div class="col-9">
                        <input type="text" class="form-control" id="rut" name="rut" required placeholder="12345678"
                            maxlength="8" pattern="[0-9]{7,8}">
                    </div>
                    <div class="col-3">
                        <input type="text" class="form-control" id="rutDv" name="rutDv" required placeholder="9"
                            maxlength="1" pattern="[0-9Kk]" readonly>
                    </div>
                </div>
                <small class="form-text text-muted">El d√≠gito verificador se calcula autom√°ticamente</small>
            </div>

            <div class="mb-3">
                <label for="carrera" class="form-label">Carrera *</label>
                <select class="form-select" id="carrera" name="carrera" required>
                    <option value="">Seleccione una carrera...</option>
                    <option value="No aplica">No aplica</option>
                    <option value="Administraci√≥n de Empresas">Administraci√≥n de Empresas</option>
                    <option value="Administraci√≥n Gastron√≥mica">Administraci√≥n Gastron√≥mica</option>
                    <option value="Analista Programador">Analista Programador</option>
                    <option value="Comercio Exterior">Comercio Exterior</option>
                    <option value="Construcci√≥n Civil">Construcci√≥n Civil</option>
                    <option value="Contabilidad General">Contabilidad General</option>
                    <option value="Contador P√∫blico">Contador P√∫blico</option>
                    <option value="Dise√±o Digital Profesional">Dise√±o Digital Profesional</option>
                    <option value="Dise√±o Digital y Web">Dise√±o Digital y Web</option>
                    <option value="Gastronom√≠a">Gastronom√≠a</option>
                    <option value="Ingenier√≠a El√©ctrica">Ingenier√≠a El√©ctrica</option>
                    <option value="Ingenier√≠a en Administraci√≥n de Empresas">Ingenier√≠a en Administraci√≥n de Empresas
                    </option>
                    <option value="Ingenier√≠a en Automatizaci√≥n y Rob√≥tica">Ingenier√≠a en Automatizaci√≥n y Rob√≥tica
                    </option>
                    <option value="Ingenier√≠a en Ciberseguridad">Ingenier√≠a en Ciberseguridad</option>
                    <option value="Ingenier√≠a en Energ√≠a">Ingenier√≠a en Energ√≠a</option>
                    <option value="Ingenier√≠a en Inform√°tica">Ingenier√≠a en Inform√°tica</option>
                    <option value="Ingenier√≠a en Log√≠stica">Ingenier√≠a en Log√≠stica</option>
                    <option value="Ingenier√≠a en Mantenimiento de Plantas Mineras">Ingenier√≠a en Mantenimiento de
                        Plantas Mineras</option>
                    <option value="Ingenier√≠a en Mantenimiento Industrial">Ingenier√≠a en Mantenimiento Industrial
                    </option>
                    <option value="Ingenier√≠a en Maquinaria Pesada y Veh√≠culos Automotrices">Ingenier√≠a en Maquinaria
                        Pesada y Veh√≠culos Automotrices</option>
                    <option value="Ingenier√≠a en Mec√°nica y Electromovilidad Automotriz">Ingenier√≠a en Mec√°nica y
                        Electromovilidad Automotriz</option>
                    <option value="Ingenier√≠a en Metalurgia">Ingenier√≠a en Metalurgia</option>
                    <option value="Ingenier√≠a en Minas">Ingenier√≠a en Minas</option>
                    <option value="Mec√°nica Automotriz en Maquinaria Pesada">Mec√°nica Automotriz en Maquinaria Pesada
                    </option>
                    <option value="T√©cnico en Automatizaci√≥n y Rob√≥tica">T√©cnico en Automatizaci√≥n y Rob√≥tica</option>
                    <option value="T√©cnico en Construcci√≥n">T√©cnico en Construcci√≥n</option>
                    <option value="T√©cnico en Electricidad Industrial">T√©cnico en Electricidad Industrial</option>
                    <option value="T√©cnico en Energ√≠as Renovables">T√©cnico en Energ√≠as Renovables</option>
                    <option value="T√©cnico en Log√≠stica">T√©cnico en Log√≠stica</option>
                    <option value="T√©cnico en Mantenimiento de Plantas Mineras">T√©cnico en Mantenimiento de Plantas
                        Mineras</option>
                    <option value="T√©cnico en Mantenimiento Industrial">T√©cnico en Mantenimiento Industrial</option>
                    <option value="T√©cnico en Mec√°nica y Electromovilidad Automotriz">T√©cnico en Mec√°nica y
                        Electromovilidad Automotriz</option>
                    <option value="T√©cnico en Miner√≠a">T√©cnico en Miner√≠a</option>
                    <option value="T√©cnico en Prevenci√≥n de Riesgos y Gesti√≥n de Emergencias">T√©cnico en Prevenci√≥n de
                        Riesgos y Gesti√≥n de Emergencias</option>
                </select>
                <small class="form-text text-muted">Solo puede seleccionar de las opciones disponibles</small>
            </div>

            <div class="mb-3">
                <label for="jornada" class="form-label">Jornada/Rol *</label>
                <select class="form-select" id="jornada" name="jornada" required>
                    <option value="Diurna" selected>Diurna</option>
                    <option value="Vespertina">Vespertina</option>
                    <option value="Profesor">Profesor</option>
                    <option value="Administrativo">Administrativo</option>
                    <option value="Externo">Externo</option>
                </select>
            </div>

            <button type="submit" class="btn w-100" id="btnCapturarVector"
                style="padding: 15px; font-size: 1.1rem; font-weight: 600;">
                <i class="bi bi-camera-fill"></i> Capturar Vector Facial
            </button>

            <!-- Bot√≥n Tomar Foto (aparece despu√©s de capturar vector) -->
            <button type="button" class="btn w-100 mt-3" id="btnTomarFoto"
                style="padding: 15px; font-size: 1.1rem; font-weight: 600; background: linear-gradient(90deg, #28a745, #218838); color: white; border: none; display: none;">
                <i class="bi bi-camera2"></i> Tomar Foto de Perfil
            </button>
        </form>

        <div id="status" class="status-message"></div>

        <div class="text-center mt-4">
            <a href="{% url 'listar_usuarios_web' %}" class="btn back-btn">
                <i class="bi bi-arrow-left"></i> Ver Lista de Usuarios
            </a>
        </div>
    </div>
</div>

<!-- Modal de Credencial INACAP -->
<div class="modal fade" id="credencialModal" tabindex="-1" aria-labelledby="credencialModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="credencial-card">
                <div class="credencial-header">INACAP</div>
                <img id="credencialFoto" class="credencial-foto" src="" alt="Foto de perfil" />
                <div class="credencial-info">
                    <h3 id="credencialNombre"></h3>
                    <p><strong>RUT:</strong> <span id="credencialRut"></span></p>
                    <p><strong>Carrera:</strong> <span id="credencialCarrera"></span></p>
                    <p><strong>Jornada:</strong> <span id="credencialJornada"></span></p>
                </div>
                <div class="credencial-actions">
                    <button id="btnRetomar" class="btn btn-warning">
                        <i class="bi bi-arrow-counterclockwise"></i> Volver a Tomar
                    </button>
                    <button id="btnAceptar" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Aceptar y Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Validaci√≥n y c√°lculo autom√°tico del d√≠gito verificador del RUT
    function calcularDV(rut) {
        let suma = 0;
        let multiplicador = 2;

        for (let i = rut.length - 1; i >= 0; i--) {
            suma += parseInt(rut[i]) * multiplicador;
            multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
        }

        const resto = suma % 11;
        const dv = 11 - resto;

        if (dv === 11) return '0';
        if (dv === 10) return 'K';
        return dv.toString();
    }

    // Leer par√°metro RUT de la URL si existe (cuando se redirige desde editar usuario)
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const rutParam = urlParams.get('rut');

        if (rutParam) {
            // Separar RUT y DV
            const partes = rutParam.split('-');
            if (partes.length === 2) {
                const rutNumero = partes[0];
                const rutDv = partes[1];

                // Prellenar campos
                document.getElementById('rut').value = rutNumero;
                document.getElementById('rutDv').value = rutDv;

                // Disparar evento 'input' para activar la b√∫squeda autom√°tica
                const inputEvent = new Event('input', { bubbles: true });
                document.getElementById('rut').dispatchEvent(inputEvent);

                console.log(`‚úÖ RUT prellenado desde URL: ${rutParam}`);
            }
        }
    });

    // Formatear RUT mientras se escribe y buscar usuario existente
    let rutBusquedaTimeout = null;
    document.getElementById('rut').addEventListener('input', async function (e) {
        let value = e.target.value.replace(/\D/g, ''); // Solo n√∫meros

        if (value.length > 8) {
            value = value.substring(0, 8);
        }

        e.target.value = value;

        // Calcular DV si tiene al menos 7 d√≠gitos
        if (value.length >= 7) {
            const dv = calcularDV(value);
            document.getElementById('rutDv').value = dv;

            // Buscar usuario existente con debounce
            clearTimeout(rutBusquedaTimeout);
            rutBusquedaTimeout = setTimeout(async () => {
                const rutCompleto = `${value}-${dv}`;
                try {
                    const response = await fetch(`/api/usuarios/${rutCompleto}/`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.usuario) {
                            // Usuario existe - autocompletar campos
                            const usuario = data.usuario;
                            document.getElementById('nombre').value = usuario.nombre || '';
                            document.getElementById('carrera').value = usuario.carrera || 'No aplica';
                            document.getElementById('jornada').value = usuario.jornada || 'Diurna';

                            // Mostrar mensaje informativo
                            const statusDiv = document.getElementById('status');
                            if (usuario.vector_facial) {
                                statusDiv.innerHTML = `
                                    <div class="alert alert-info" style="margin-top: 15px;">
                                        <i class="bi bi-info-circle"></i> 
                                        <strong>${usuario.nombre}</strong> ya tiene datos biom√©tricos. 
                                        Puedes actualizar su perfil facial capturando nuevamente.
                                    </div>`;
                            } else {
                                statusDiv.innerHTML = `
                                    <div class="alert alert-warning" style="margin-top: 15px;">
                                        <i class="bi bi-exclamation-triangle"></i> 
                                        <strong>${usuario.nombre}</strong> est√° registrado pero sin datos biom√©tricos. 
                                        Contin√∫a para agregar su perfil facial.
                                    </div>`;
                            }
                        }
                    } else {
                        // Usuario no existe - limpiar mensaje
                        document.getElementById('status').innerHTML = '';
                    }
                } catch (error) {
                    console.log('RUT no encontrado o error en b√∫squeda');
                }
            }, 500); // Esperar 500ms despu√©s de que el usuario deje de escribir
        } else {
            document.getElementById('rutDv').value = '';
            document.getElementById('status').innerHTML = '';
        }
    });

    // RTSP stream - no requiere verificaci√≥n de conexi√≥n

    // Manejar env√≠o del formulario con progreso en tiempo real
    let progressInterval = null;

    document.getElementById('registroForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const btnCapturarVector = document.getElementById('btnCapturarVector');
        const statusDiv = document.getElementById('status');
        const cameraPlaceholder = document.getElementById('cameraPlaceholder');
        const streamImage = document.getElementById('streamImage');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const cameraStatus = document.getElementById('cameraStatus');

        // Concatenar RUT + DV
        const rutCompleto = document.getElementById('rut').value + '-' + document.getElementById('rutDv').value;

        const datos = {
            nombre: document.getElementById('nombre').value.trim(),
            rut: rutCompleto,
            carrera: document.getElementById('carrera').value.trim(),
            jornada: document.getElementById('jornada').value,
            guardar: true
        };

        // Deshabilitar bot√≥n
        btnCapturarVector.disabled = true;
        btnCapturarVector.innerHTML = '<span class="loading"></span>Iniciando captura...';

        // MOSTRAR C√ÅMARA Y PROGRESO
        cameraPlaceholder.style.display = 'none';
        streamImage.style.display = 'block';
        progressContainer.style.display = 'block';
        cameraStatus.textContent = 'Capturando...';

        // Funci√≥n para obtener progreso
        const checkProgress = async () => {
            try {
                const progResponse = await fetch('/api/luckfox/progreso/');
                const progData = await progResponse.json();

                if (progData.active) {
                    // Actualizar barra de progreso
                    const percentage = progData.percentage;
                    progressBar.style.width = percentage + '%';
                    progressBar.textContent = percentage + '%';
                    progressBar.setAttribute('aria-valuenow', percentage);
                    progressText.textContent = `${progData.current} de ${progData.total} capturas`;
                } else if (progData.status === 'completed') {
                    // Captura completada
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';
                    progressText.textContent = '¬°Captura completada!';
                }
            } catch (error) {
                console.error('Error obteniendo progreso:', error);
            }
        };

        // Iniciar polling de progreso
        progressInterval = setInterval(checkProgress, 300); // Cada 300ms

        try {
            statusDiv.className = 'status-message info';
            statusDiv.style.display = 'block';
            statusDiv.textContent = 'üì∏ Capturando 100 frames de tu rostro...';

            const response = await fetch('/api/luckfox/capturar/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(datos)
            });

            const result = await response.json();

            // Detener polling
            clearInterval(progressInterval);

            if (result.success) {
                statusDiv.className = 'status-message success';
                statusDiv.innerHTML = `<i class="bi bi-check-circle-fill"></i> ${result.message}`;

                document.getElementById('registroForm').reset();

                if (result.usuario_guardado) {
                    setTimeout(() => {
                        statusDiv.innerHTML += '<br><small>Redirigiendo a lista de usuarios...</small>';
                        window.location.href = '/usuarios/';
                    }, 2000);
                }

                // OCULTAR C√ÅMARA despu√©s de 2 segundos
                setTimeout(() => {
                    streamImage.style.display = 'none';
                    progressContainer.style.display = 'none';
                    cameraPlaceholder.style.display = 'flex';
                    cameraStatus.textContent = 'Vista en espera';
                }, 2000);
            } else {
                statusDiv.className = 'status-message error';
                statusDiv.innerHTML = `<i class="bi bi-x-circle-fill"></i> ${result.message}`;

                // OCULTAR C√ÅMARA si hay error
                streamImage.style.display = 'none';
                progressContainer.style.display = 'none';
                cameraPlaceholder.style.display = 'flex';
                cameraStatus.textContent = 'Vista en espera';
            }
        } catch (error) {
            statusDiv.className = 'status-message error';
            statusDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Error: ${error.message}`;
        } finally {
            btnCapturarVector.disabled = false;
            btnCapturarVector.innerHTML = '<i class="bi bi-camera-fill"></i> Capturar Vector Facial';
        }
    });

    // RTSP stream no requiere verificaci√≥n peri√≥dica

</script>
{% endblock %}